# ===========================================
# GitHub Actions: 自动构建和部署到 Azure
# ===========================================
# 触发条件：push 到 main 分支
# ===========================================

name: Build and Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 允许手动触发

env:
  AZURE_RESOURCE_GROUP: yanxia-rg
  ACR_NAME: yanxiaacr  # Azure Container Registry 名称
  API_APP_NAME: yanxia-api
  AGENT_APP_NAME: yanxia-agent
  WEB_APP_NAME: yanxia-web

jobs:
  # ===========================================
  # 构建并推送 Docker 镜像
  # ===========================================
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Generate image tag
        id: meta
        run: |
          echo "version=$(date +'%Y%m%d')-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      # 构建并推送 API 镜像
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./server-dotnet
          file: ./server-dotnet/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/yanxia-api:${{ steps.meta.outputs.version }}
            ${{ env.ACR_NAME }}.azurecr.io/yanxia-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 构建并推送 Agent 镜像
      - name: Build and push Agent image
        uses: docker/build-push-action@v5
        with:
          context: ./agent-service
          file: ./agent-service/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/yanxia-agent:${{ steps.meta.outputs.version }}
            ${{ env.ACR_NAME }}.azurecr.io/yanxia-agent:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 构建并推送 Web 镜像
      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/yanxia-web:${{ steps.meta.outputs.version }}
            ${{ env.ACR_NAME }}.azurecr.io/yanxia-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # 运行数据库迁移
  # ===========================================
  migrate:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # 安装 psql 客户端
          sudo apt-get update && sudo apt-get install -y postgresql-client
          
          # 运行主迁移脚本
          echo "Running main migration..."
          psql "$DATABASE_URL" -f ./server-dotnet/migrate.sql
          
          echo "Migration completed!"

  # ===========================================
  # 生成 appsettings.json 并部署
  # ===========================================
  prepare-config:
    needs: migrate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate appsettings.json from template
        run: |
          sed -e "s|\${DATABASE_URL}|${{ secrets.DATABASE_URL }}|g" \
              -e "s|\${AZURE_STORAGE_CONNECTION_STRING}|${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}|g" \
              -e "s|\${OPENAI_API_KEY}|${{ secrets.OPENAI_API_KEY }}|g" \
              -e "s|\${ANTHROPIC_API_KEY}|${{ secrets.ANTHROPIC_API_KEY }}|g" \
              -e "s|\${WECOM_CORP_ID}|${{ secrets.WECOM_CORP_ID }}|g" \
              -e "s|\${WECOM_AGENT_ID}|${{ secrets.WECOM_AGENT_ID }}|g" \
              -e "s|\${WECOM_SECRET}|${{ secrets.WECOM_SECRET }}|g" \
              ./server-dotnet/appsettings.template.json > ./server-dotnet/appsettings.json
          echo "Config generated successfully"

  # ===========================================
  # 部署到 Azure App Service
  # ===========================================
  deploy:
    needs: [build, prepare-config]
    runs-on: ubuntu-latest
    
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 部署 API
      - name: Deploy API to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.API_APP_NAME }}
          images: ${{ env.ACR_NAME }}.azurecr.io/yanxia-api:${{ needs.build.outputs.image_tag }}

      # 部署 Agent
      - name: Deploy Agent to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AGENT_APP_NAME }}
          images: ${{ env.ACR_NAME }}.azurecr.io/yanxia-agent:${{ needs.build.outputs.image_tag }}

      # 部署 Web
      - name: Deploy Web to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.WEB_APP_NAME }}
          images: ${{ env.ACR_NAME }}.azurecr.io/yanxia-web:${{ needs.build.outputs.image_tag }}

      - name: Logout from Azure
        run: az logout









