{
  "schema": {
    "type": "object",
    "$schema": "https://json-schema.org/draft/2019-09/schema",
    "properties": {
      "header": {
        "type": "object",
        "properties": {
          "companyCode": { "type": "string", "minLength": 4, "maxLength": 4 },
          "postingDate": { "type": "string", "format": "date" },
          "voucherType": { "type": "string", "enum": ["GL","AP","AR","AA","SA","IN","OT"] },
          "voucherNo": { "type": "string", "pattern": "^\\d{10}$" },
          "summary": { "type": "string", "maxLength": 500 },
          "currency": { "type": "string", "enum": ["JPY","USD","CNY"] },
          "invoiceRegistrationNo": { "type": ["string","null"], "pattern": "^(T\\d{13})?$", "description": "インボイス登録番号" },
          "createdAt": { "type": ["string","null"], "format": "date-time", "description": "作成日時" },
          "createdBy": { "type": ["string","null"], "description": "作成者ID" },
          "updatedAt": { "type": ["string","null"], "format": "date-time", "description": "更新日時" },
          "updatedBy": { "type": ["string","null"], "description": "更新者ID" }
        },
        "required": ["companyCode","postingDate","voucherType","currency"]
      },
      "lines": {
        "type": "array",
        "minItems": 1,
        "items": {
          "type": "object",
          "properties": {
            "lineNo": { "type": "integer" },
            "accountCode": { "type": "string" },
            "drcr": { "type": "string", "enum": ["DR","CR"] },
            "amount": { "type": "number" },
            "departmentId": { "type": ["string","null"] },
            "employeeId": { "type": ["string","null"] },
            "vendorId": { "type": ["string","null"] },
            "customerId": { "type": ["string","null"] },
            "assetId": { "type": ["string","null"], "description": "固定資産ID" },
            "paymentDate": { "type": ["string","null"], "format": "date" },
            "note": { "type": ["string","null"], "maxLength": 200 },
            "isTaxLine": { "type": "boolean", "default": false, "description": "消費税明細行フラグ" },
            "baseLineNo": { "type": ["integer","null"], "description": "関連する税基明細の行番号" },
            "taxRate": { "type": ["number","null"], "description": "税率（パーセント）" },
            "taxType": { "type": ["string","null"], "enum": [null, "OUTPUT_TAX", "INPUT_TAX"], "description": "税種別" },
            "tax": {
              "type": ["object","null"],
              "description": "消費税入力用オブジェクト（FinanceServiceで展開される）",
              "properties": {
                "accountCode": { "type": "string", "description": "消費税科目コード" },
                "amount": { "type": "number", "description": "消費税額" },
                "side": { "type": "string", "enum": ["DR","CR"], "description": "借貸区分" },
                "rate": { "type": "number", "description": "税率" },
                "taxType": { "type": "string", "description": "税種別" }
              }
            }
          },
          "required": ["lineNo","accountCode","drcr","amount"]
        }
      },
      "attachments": {
        "type": "array",
        "description": "添付ファイル一覧",
        "items": {
          "type": "object",
          "properties": {
            "id": { "type": "string", "description": "ファイルID" },
            "name": { "type": "string", "description": "ファイル名" },
            "contentType": { "type": "string", "description": "MIMEタイプ" },
            "size": { "type": "integer", "description": "ファイルサイズ（バイト）" },
            "blobName": { "type": "string", "description": "Azure Blob名" },
            "url": { "type": "string", "description": "アクセスURL" },
            "uploadedAt": { "type": "string", "format": "date-time", "description": "アップロード日時" }
          },
          "required": ["id", "name"]
        }
      },
      "analysis": {
        "type": ["object","null"],
        "description": "AI解析結果（請求書OCR等）",
        "properties": {
          "vendorName": { "type": "string" },
          "totalAmount": { "type": "number" },
          "taxAmount": { "type": "number" },
          "taxRate": { "type": "number" },
          "invoiceDate": { "type": "string", "format": "date" },
          "invoiceRegistrationNo": { "type": "string" },
          "items": { "type": "array" }
        }
      }
    },
    "required": ["header","lines"],
    "allOf": [
      {
        "if": { "properties": { "header": { "properties": { "currency": { "const": "JPY" } } } } },
        "then": { "properties": { "lines": { "items": { "properties": { "amount": { "type": "integer", "minimum": 0 } } } } } },
        "else": { "properties": { "lines": { "items": { "properties": { "amount": { "type": "number", "minimum": 0, "multipleOf": 0.01 } } } } } }
      }
    ]
  },
  "ui": {
    "form": {
      "layout": [
        {
          "type": "grid",
          "cols": [
            { "field": "header.companyCode", "label": "公司代码", "span": 6, "widget": "input", "readonly": true },
            { "field": "header.postingDate", "label": "记账日期", "span": 6, "widget": "date" },
            { "field": "header.voucherType", "label": "凭证类型", "span": 6, "widget": "select", "options": ["GL","AP","AR","AA","SA","IN","OT"] },
            { "field": "header.currency", "label": "币种", "span": 6, "widget": "select", "options": ["JPY","USD","CNY"] },
            { "field": "header.summary", "label": "摘要", "span": 24, "widget": "textarea", "props": { "rows": 2, "maxlength": 500, "showWordLimit": true } }
          ]
        },
        {
          "type": "table",
          "field": "lines",
          "label": "分录行",
          "columns": [
            { "field": "lineNo", "label": "#", "width": 60, "widget": "index" },
            {
              "field": "accountCode",
              "label": "科目",
              "minWidth": 200,
              "widget": "select",
              "dataSource": {
                "type": "api",
                "url": "/objects/account/search",
                "method": "POST",
                "body": { "where": [], "page": 1, "pageSize": 200 },
                "map": { "label": "${payload.name} (${account_code})", "value": "${account_code}" },
                "search": { "param": "q", "toDsl": { "template": { "where": [{ "json": "name", "op": "eq", "value": "${q}" }], "page": 1, "pageSize": 50 } } },
                "cache": true
              }
            },
            { "field": "drcr", "label": "借/贷", "width": 120, "widget": "select", "options": [{ "label": "借方", "value": "DR" }, { "label": "贷方", "value": "CR" }] },
            { "field": "amount", "label": "金额", "width": 160, "widget": "number", "props": { "min": 0, "step": 1 } },
            { "field": "departmentId", "label": "部门", "minWidth": 140, "widget": "input" },
            { "field": "employeeId", "label": "员工", "minWidth": 140, "widget": "input" },
            {
              "field": "customerId",
              "label": "客户",
              "minWidth": 200,
              "widget": "select",
              "dataSource": {
                "type": "api",
                "url": "/objects/businesspartner/search",
                "method": "POST",
                "body": { "where": [{ "field": "flag_customer", "op": "eq", "value": true }], "page": 1, "pageSize": 200 },
                "map": { "label": "${payload.name} (${partner_code})", "value": "${partner_code}" },
                "search": { "param": "q", "toDsl": { "template": { "where": [ { "field": "flag_customer", "op": "eq", "value": true }, { "json": "name", "op": "eq", "value": "${q}" } ], "page": 1, "pageSize": 50 } } },
                "cache": true
              }
            },
            {
              "field": "vendorId",
              "label": "供应商",
              "minWidth": 200,
              "widget": "select",
              "dataSource": {
                "type": "api",
                "url": "/objects/businesspartner/search",
                "method": "POST",
                "body": { "where": [{ "field": "flag_vendor", "op": "eq", "value": true }], "page": 1, "pageSize": 200 },
                "map": { "label": "${payload.name} (${partner_code})", "value": "${partner_code}" },
                "search": { "param": "q", "toDsl": { "template": { "where": [ { "field": "flag_vendor", "op": "eq", "value": true }, { "json": "name", "op": "eq", "value": "${q}" } ], "page": 1, "pageSize": 50 } } },
                "cache": true
              }
            },
            { "field": "paymentDate", "label": "支付日", "minWidth": 160, "widget": "date" },
            { "field": "note", "label": "备注", "minWidth": 160, "widget": "input" }
          ],
          "rowActions": [{ "type": "delete", "label": "删除" }],
          "footer": { "totals": [{ "expr": "sum(amount where drcr=DR)", "label": "合计借方" }, { "expr": "sum(amount where drcr=CR)", "label": "合计贷方" }] }
        }
      ]
    },
    "list": { "columns": ["posting_date","voucher_type","voucher_no"] }
  },
  "query": {
    "filters": ["posting_date","voucher_type","voucher_no","lines[].employeeId","lines[].accountCode","header.currency"],
    "sorts": ["posting_date","voucher_no"]
  },
  "core_fields": {
    "coreFields": [
      { "name": "posting_date", "path": "header.postingDate", "type": "date", "index": { "strategy": "generated_column", "unique": false } },
      { "name": "voucher_type", "path": "header.voucherType", "type": "string", "index": { "strategy": "generated_column", "unique": false } },
      { "name": "voucher_no", "path": "header.voucherNo", "type": "string", "index": { "strategy": "generated_column", "unique": true, "scope": ["company_code"] } }
    ]
  },
  "validators": ["voucher_balance_check_v2"],
  "numbering": { "strategy": "yymm6", "targetPath": "header.voucherNo" },
  "ai_hints": {
    "displayNames": { "ja": "仕訳", "zh": "会计凭证", "en": "Voucher" },
    "synonyms": ["凭证","仕訳","会计分录","journal"],
    "typeMap": { "工资凭证": "SA", "給与仕訳": "SA", "入金": "IN", "出金": "OT" }
  }
}
