using System;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;
using System.Text.Json;
using System.Text.Json.Nodes;
using Npgsql;

namespace Server.Modules;

public sealed class InvoiceTaskService
{
    private readonly NpgsqlDataSource _ds;

    private static readonly JsonSerializerOptions JsonOptions = new(JsonSerializerDefaults.Web)
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        WriteIndented = false
    };

    public InvoiceTaskService(NpgsqlDataSource ds)
    {
        _ds = ds;
    }

    public sealed record InvoiceTask(
        Guid Id,
        Guid SessionId,
        string CompanyCode,
        string FileId,
        string DocumentSessionId,
        string FileName,
        string? ContentType,
        long Size,
        string? BlobName,
        string? DocumentLabel,
        string? StoredPath,
        string? UserId,
        string Status,
        string? Summary,
        JsonObject? Analysis,
        JsonObject Metadata,
        DateTimeOffset CreatedAt,
        DateTimeOffset UpdatedAt);

    public async Task<InvoiceTask> CreateAsync(
        Guid sessionId,
        string companyCode,
        string fileId,
        UploadedFileRecord record,
        string documentSessionId,
        JsonObject? analysis,
        string? documentLabel,
        CancellationToken ct)
    {
        var id = Guid.NewGuid();
        await using var conn = await _ds.OpenConnectionAsync(ct);
        await using var cmd = conn.CreateCommand();

        var metadata = new JsonObject();
        if (!string.IsNullOrWhiteSpace(record.StoredPath))
        {
            metadata["storedPath"] = record.StoredPath;
        }
        metadata["uploadedAt"] = record.UploadedAt.ToString("O");
        var analysisClone = analysis?.DeepClone().AsObject();
        var summary = BuildSummary(analysisClone);

        cmd.CommandText = """
            INSERT INTO ai_invoice_tasks
            (id, session_id, company_code, file_id, document_session_id, file_name, content_type, file_size, blob_name, document_label, stored_path, user_id, status, summary, analysis, metadata, created_at, updated_at)
            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, 'pending', $13, $14::jsonb, $15::jsonb, now(), now())
            RETURNING id, session_id, company_code, file_id, document_session_id, file_name, content_type, file_size, blob_name, document_label, stored_path, user_id, status, summary, analysis, metadata, created_at, updated_at;
            """;
        cmd.Parameters.AddWithValue(id);
        cmd.Parameters.AddWithValue(sessionId);
        cmd.Parameters.AddWithValue(companyCode);
        cmd.Parameters.AddWithValue(fileId);
        cmd.Parameters.AddWithValue(documentSessionId);
        cmd.Parameters.AddWithValue(record.FileName ?? "uploaded");
        cmd.Parameters.AddWithValue(string.IsNullOrWhiteSpace(record.ContentType) ? "application/octet-stream" : record.ContentType);
        cmd.Parameters.AddWithValue(record.Size);
        cmd.Parameters.AddWithValue(string.IsNullOrWhiteSpace(record.BlobName) ? DBNull.Value : record.BlobName);
        cmd.Parameters.AddWithValue(string.IsNullOrWhiteSpace(documentLabel) ? DBNull.Value : documentLabel);
        cmd.Parameters.AddWithValue(string.IsNullOrWhiteSpace(record.StoredPath) ? DBNull.Value : record.StoredPath);
        cmd.Parameters.AddWithValue(string.IsNullOrWhiteSpace(record.UserId) ? DBNull.Value : record.UserId);
        cmd.Parameters.AddWithValue(string.IsNullOrWhiteSpace(summary) ? DBNull.Value : summary);
        cmd.Parameters.AddWithValue(analysisClone is null ? DBNull.Value : JsonSerializer.Serialize(analysisClone, JsonOptions));
        cmd.Parameters.AddWithValue(JsonSerializer.Serialize(metadata, JsonOptions));

        await using var reader = await cmd.ExecuteReaderAsync(ct);
        if (!await reader.ReadAsync(ct))
        {
            throw new Exception("创建发票任务失败");
        }
        return ReadTask(reader);
    }

    public async Task<IReadOnlyList<InvoiceTask>> ListAsync(Guid sessionId, CancellationToken ct)
    {
        var list = new List<InvoiceTask>();
        await using var conn = await _ds.OpenConnectionAsync(ct);
        await using var cmd = conn.CreateCommand();
        cmd.CommandText = """
            SELECT id, session_id, company_code, file_id, document_session_id, file_name, content_type, file_size, blob_name, document_label, stored_path, user_id, status, summary, analysis, metadata, created_at, updated_at
            FROM ai_invoice_tasks
            WHERE session_id = $1
            ORDER BY created_at;
            """;
        cmd.Parameters.AddWithValue(sessionId);
        await using var reader = await cmd.ExecuteReaderAsync(ct);
        while (await reader.ReadAsync(ct))
        {
            list.Add(ReadTask(reader));
        }
        return list;
    }

    public async Task<InvoiceTask?> GetAsync(Guid taskId, CancellationToken ct)
    {
        await using var conn = await _ds.OpenConnectionAsync(ct);
        await using var cmd = conn.CreateCommand();
        cmd.CommandText = """
            SELECT id, session_id, company_code, file_id, document_session_id, file_name, content_type, file_size, blob_name, document_label, stored_path, user_id, status, summary, analysis, metadata, created_at, updated_at
            FROM ai_invoice_tasks
            WHERE id = $1;
            """;
        cmd.Parameters.AddWithValue(taskId);
        await using var reader = await cmd.ExecuteReaderAsync(ct);
        if (!await reader.ReadAsync(ct))
        {
            return null;
        }
        return ReadTask(reader);
    }

    public async Task UpdateStatusAsync(Guid taskId, string status, JsonObject? metadata, CancellationToken ct)
    {
        await using var conn = await _ds.OpenConnectionAsync(ct);
        await using var cmd = conn.CreateCommand();
        if (metadata is null)
        {
            cmd.CommandText = """
                UPDATE ai_invoice_tasks
                SET status = $2, updated_at = now()
                WHERE id = $1;
                """;
            cmd.Parameters.AddWithValue(taskId);
            cmd.Parameters.AddWithValue(status);
        }
        else
        {
            cmd.CommandText = """
                UPDATE ai_invoice_tasks
                SET status = $2,
                    metadata = metadata || $3::jsonb,
                    updated_at = now()
                WHERE id = $1;
                """;
            cmd.Parameters.AddWithValue(taskId);
            cmd.Parameters.AddWithValue(status);
            cmd.Parameters.AddWithValue(JsonSerializer.Serialize(metadata, JsonOptions));
        }
        await cmd.ExecuteNonQueryAsync(ct);
    }

    private static InvoiceTask ReadTask(NpgsqlDataReader reader)
    {
        var analysisObj = reader.IsDBNull(14)
            ? null
            : JsonNode.Parse(reader.GetString(14))?.AsObject();
        var metadataObj = reader.IsDBNull(15)
            ? new JsonObject()
            : (JsonNode.Parse(reader.GetString(15))?.AsObject() ?? new JsonObject());
        return new InvoiceTask(
            reader.GetGuid(0),
            reader.GetGuid(1),
            reader.GetString(2),
            reader.GetString(3),
            reader.GetString(4),
            reader.GetString(5),
            reader.IsDBNull(6) ? null : reader.GetString(6),
            reader.IsDBNull(7) ? 0L : reader.GetInt64(7),
            reader.IsDBNull(8) ? null : reader.GetString(8),
            reader.IsDBNull(9) ? null : reader.GetString(9),
            reader.IsDBNull(10) ? null : reader.GetString(10),
            reader.IsDBNull(11) ? null : reader.GetString(11),
            reader.GetString(12),
            reader.IsDBNull(13) ? null : reader.GetString(13),
            analysisObj,
            metadataObj,
            reader.GetFieldValue<DateTimeOffset>(16),
            reader.GetFieldValue<DateTimeOffset>(17));
    }

    private static string? BuildSummary(JsonObject? analysis)
    {
        if (analysis is null) return null;
        var parts = new List<string>();
        if (TryGetJsonString(analysis, "partnerName", out var partner) && !string.IsNullOrWhiteSpace(partner))
        {
            parts.Add($"供应方：{partner}");
        }
        if (TryGetJsonString(analysis, "issueDate", out var issueDate) && !string.IsNullOrWhiteSpace(issueDate))
        {
            parts.Add($"日期：{issueDate}");
        }
        var amount = TryGetJsonDecimal(analysis, "totalAmount");
        if (amount.HasValue && amount.Value > 0)
        {
            parts.Add($"含税金额：{amount.Value:0.##}");
        }
        return parts.Count == 0 ? null : string.Join("，", parts);
    }

    private static bool TryGetJsonString(JsonObject obj, string property, out string? value)
    {
        value = null;
        if (!obj.TryGetPropertyValue(property, out var node) || node is not JsonValue jsonValue) return false;
        if (!jsonValue.TryGetValue<string>(out var str) || string.IsNullOrWhiteSpace(str)) return false;
        value = str.Trim();
        return true;
    }

    private static decimal? TryGetJsonDecimal(JsonObject obj, string property)
    {
        if (!obj.TryGetPropertyValue(property, out var node) || node is not JsonValue jsonValue) return null;
        if (jsonValue.TryGetValue<decimal>(out var dec)) return dec;
        if (jsonValue.TryGetValue<double>(out var dbl)) return Convert.ToDecimal(dbl);
        if (jsonValue.TryGetValue<string>(out var str) && decimal.TryParse(str, out var parsed)) return parsed;
        return null;
    }
}

