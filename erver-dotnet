[1mdiff --git a/server-dotnet/Program.cs b/server-dotnet/Program.cs[m
[1mindex 18086d2..01cafdd 100644[m
[1m--- a/server-dotnet/Program.cs[m
[1m+++ b/server-dotnet/Program.cs[m
[36m@@ -1,5 +1,4 @@[m
 // =============================[m
[31m-// æœ¬æ–‡ä»¶ä¸ºæœ€å°å¯è¿è¡Œçš„ .NET 8 Web API å…¥å£ï¼š[m
 // - å¯åŠ¨æ—¶æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆåˆ›å»ºè¡¨/ç”Ÿæˆåˆ—/ç´¢å¼•/ç§å­ jsonstructuresï¼‰[m
 // - é€šç”¨ CRUD ä¸æœç´¢ DSLï¼ˆé€šè¿‡ jsonstructures çš„ schema/query/coreFields é©±åŠ¨ï¼‰[m
 // - å‡­è¯ç‰¹æ®Šé€»è¾‘ï¼šå€Ÿè´·å¹³è¡¡æ ¡éªŒã€yymm+6 ç¼–å·ã€æ³¨å…¥ companyCode/voucherNo[m
[36m@@ -22,6 +21,12 @@[m [musing Server.Domain; // å¼•å…¥ SchemasService[m
 using Server.Modules;[m
 using System.Security.Cryptography;[m
 using System.Text.Json.Nodes;[m
[32m+[m[32musing Microsoft.AspNetCore.Mvc;[m
[32m+[m[32musing System.Globalization;[m
[32m+[m[32musing System.Collections.Concurrent;[m
[32m+[m[32musing System.IO.Compression;[m
[32m+[m[32musing System.Text.RegularExpressions;[m
[32m+[m[32musing Microsoft.AspNetCore.Http;[m
 [m
 // æƒé™è¾…åŠ©ï¼ˆéœ€ç½®äºé¡¶éƒ¨ï¼Œå…ˆäºé¡¶å±‚è¯­å¥ï¼‰[m
 // æƒé™æ¨¡å‹ï¼š[m
[36m@@ -52,11 +57,23 @@[m [mbuilder.Services.AddAzureBlob(builder.Configuration);[m
 builder.Services.AddSingleton<Server.Infrastructure.LawDatasetService>();[m
 builder.Services.AddScoped<Server.Modules.HrCrudService>();[m
 builder.Services.AddScoped<Server.Modules.InvoiceRegistryService>();[m
[32m+[m[32mbuilder.Services.Configure<Server.Infrastructure.AiMessageCleanupOptions>(builder.Configuration.GetSection("AiMessageCleanup"));[m
[32m+[m[32mbuilder.Services.Configure<AzureStorageOptions>(builder.Configuration.GetSection("AzureStorage"));[m
[32m+[m[32mbuilder.Services.AddSingleton<AzureBlobService>();[m
[32m+[m[32mbuilder.Services.AddHostedService<Server.Infrastructure.AiMessageCleanupService>();[m
 builder.Services.AddScoped<Server.Modules.FinanceService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.FinancialStatementService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.WorkflowRulesService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.VoucherAutomationService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.BankImportService>();[m
 builder.Services.AddHttpClient();[m
 builder.Services.AddSingleton<Server.Infrastructure.ApnsService>();[m
 builder.Services.AddHostedService<Server.Infrastructure.NotificationSchedulerService>();[m
 builder.Services.AddHostedService<Server.Infrastructure.TaskSchedulerService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.AgentScenarioService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.AgentAccountingRuleService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.InvoiceTaskService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.SalesOrderTaskService>();[m
 [m
 // CORSï¼ˆå¼€å‘ç¯å¢ƒæ”¾å¼€ï¼‰åº”åœ¨ Build ä¹‹å‰æ³¨å†Œ[m
 builder.Services.AddCors(opts =>[m
[36m@@ -87,10 +104,64 @@[m [mbuilder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)[m
     });[m
 builder.Services.AddAuthorization();[m
 [m
[32m+[m[32mbuilder.Services.AddHttpClient("openai", client =>[m
[32m+[m[32m{[m
[32m+[m[32m    client.BaseAddress = new Uri("https://api.openai.com/");[m
[32m+[m[32m    client.Timeout = TimeSpan.FromSeconds(240);[m
[32m+[m[32m});[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.AgentKitService>();[m
[32m+[m[32mbuilder.Services.AddScoped<Server.Modules.AgentScenarioService>();[m
[32m+[m
 var app = builder.Build();[m
[32m+[m[32mvar uploadRoot = Path.Combine(AppContext.BaseDirectory, "uploads", "ai-files");[m
[32m+[m[32mDirectory.CreateDirectory(uploadRoot);[m
[32m+[m[32mvar uploadedFiles = new ConcurrentDictionary<string, UploadedFileRecord>();[m
[32m+[m
[32m+[m[32mvar logsDir = Path.Combine(AppContext.BaseDirectory, "logs");[m
[32m+[m[32mDirectory.CreateDirectory(logsDir);[m
[32m+[m[32mvar aiTasksLogPath = Path.Combine(logsDir, "ai_tasks.log");[m
[32m+[m[32mvar aiTasksLogLock = new object();[m
[32m+[m[32mvoid AppendAiTasksLog(string message)[m
[32m+[m[32m{[m
[32m+[m[32m    lock (aiTasksLogLock)[m
[32m+[m[32m    {[m
[32m+[m[32m        File.AppendAllText(aiTasksLogPath, $"[{DateTimeOffset.UtcNow:O}] {message}{Environment.NewLine}");[m
[32m+[m[32m    }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mvar searchRequestJsonOptions = new JsonSerializerOptions(JsonSerializerDefaults.Web)[m
[32m+[m[32m{[m
[32m+[m[32m    PropertyNameCaseInsensitive = true[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32mtry[m
[32m+[m[32m{[m
[32m+[m[32m    using var scope = app.Services.CreateScope();[m
[32m+[m[32m    var financial = scope.ServiceProvider.GetRequiredService<FinancialStatementService>();[m
[32m+[m[32m    var defaultCompany = builder.Configuration.GetSection("App").GetValue<string>("DefaultCompany") ?? "JP01";[m
[32m+[m[32m    financial.SeedDefaultTemplateAsync(defaultCompany).GetAwaiter().GetResult();[m
[32m+[m[32m}[m
[32m+[m[32mcatch (Exception ex)[m
[32m+[m[32m{[m
[32m+[m[32m    Console.WriteLine($"[financial] seed skipped: {ex.Message}");[m
[32m+[m[32m}[m
[32m+[m
 // å…¨å±€æœ€æ—©æ³¨å…¥ CORS å…è®¸å¤´ï¼ˆåŒ…æ‹¬å‡ºç°å¼‚å¸¸/401 æ—¶ï¼‰ï¼Œå¹¶å¤„ç†é¢„æ£€[m
[31m-// ç»Ÿä¸€ CORS å¤„ç†ï¼ˆå•ä¸€ä¸­é—´ä»¶ï¼Œè¦†ç›–é¢„æ£€å’Œæ‰€æœ‰å“åº”ï¼‰[m
 app.UseCors("DevAll");[m
[32m+[m[32m// å…¼å®¹ç›´æ¥è®¿é—®åç«¯çš„ /api å‰ç¼€ï¼ˆä¾‹å¦‚ç»•è¿‡ Vite ä»£ç†æ—¶ï¼‰[m
[32m+[m[32mapp.Use(async (ctx, next) =>[m
[32m+[m[32m{[m
[32m+[m[32m    if (ctx.Request.Path.StartsWithSegments("/api", out var remaining))[m
[32m+[m[32m    {[m
[32m+[m[32m        Console.WriteLine($"[PathRewrite] {ctx.Request.Path} -> {remaining}");[m
[32m+[m[32m        ctx.Request.Path = remaining;[m
[32m+[m[32m        if (!ctx.Request.Path.HasValue)[m
[32m+[m[32m        {[m
[32m+[m[32m            ctx.Request.Path = "/";[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m[32m    await next();[m
[32m+[m[32m});[m
 // å…œåº•ï¼šç¡®ä¿æ‰€æœ‰å“åº”éƒ½å¸¦ä¸Š CORS å¤´ï¼ˆåŒ…æ‹¬ 401/403/å¼‚å¸¸ï¼‰[m
 app.Use(async (ctx, next) =>[m
 {[m
[36m@@ -728,6 +799,9 @@[m [mServer.Modules.LocalizationMaintenanceModule.MapLocalizationMaintenanceModule(ap[m
 // æ³¨å†Œ CRM æ¨¡å—ç«¯ç‚¹[m
 Server.Modules.CrmModule.MapCrmModule(app);[m
 [m
[32m+[m[32m// åŸºç¡€æ ¹è·¯å¾„æ¢æ´»ï¼Œé¿å…è¿”å› 405[m
[32m+[m[32mapp.MapGet("/", () => Results.Json(new { ok = true })).AllowAnonymous();[m
[32m+[m
 app.MapGet("/health", async (IServiceProvider sp) =>[m
 {[m
     var env = app.Environment.EnvironmentName;[m
[36m@@ -784,7 +858,6 @@[m [mapp.MapGet("/debug/open-items", async (string voucherNo, NpgsqlDataSource ds, Ht[m
     while (await rd.ReadAsync()) rows.Add(rd.GetFieldValue<string>(0));[m
     return Results.Text("[" + string.Join(',', rows) + "]", "application/json");[m
 }).RequireAuthorization();[m
[31m-[m
 // ç»´æŠ¤ï¼šé‡å»º open_items æŠ•å½±ï¼ˆæŒ‰å‡­è¯å·æˆ–å…¨éƒ¨ï¼‰[m
 app.MapPost("/maintenance/open-items/rebuild", async (HttpRequest req, NpgsqlDataSource ds) =>[m
 {[m
[36m@@ -925,7 +998,7 @@[m [mapp.MapPost("/dev/seed-user", async (HttpRequest req, NpgsqlDataSource ds) =>[m
         await map.ExecuteNonQueryAsync();[m
     }[m
     // ç»™è§’è‰²åŠ ä¸€äº›åŸºç¡€èƒ½åŠ›ï¼Œä¾¿äºæ¼”ç¤º[m
[31m-    var caps = new[]{ "roles:manage", "op:bank-collect", "op:bank-payment" };[m
[32m+[m[32m    var caps = new[]{ "roles:manage", "op:bank-collect", "op:bank-payment", "report:financial" };[m
     foreach (var cap in caps)[m
     {[m
         await using var capCmd = conn.CreateCommand();[m
[36m@@ -940,24 +1013,33 @@[m [mapp.MapPost("/dev/seed-user", async (HttpRequest req, NpgsqlDataSource ds) =>[m
 // ç™»å½•æ¥å£ï¼šcompanyCode + employeeCode + password -> JWT[m
 app.MapPost("/auth/login", async (HttpRequest req, NpgsqlDataSource ds) =>[m
 {[m
[31m-    using var doc = await JsonDocument.ParseAsync(req.Body);[m
[31m-    var root = doc.RootElement;[m
[3